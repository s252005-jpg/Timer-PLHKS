<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>PLHKS Timer</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Linux Libertine', Georgia, serif; background: #ffffff; color:#000; padding:15px; min-height:100vh; user-select:none;}
        body.dark { background:#1a1a1a; color:#d5d5d5; }
        .container { max-width:900px; margin:10px auto; padding:15px; position:relative; }
        h1 { text-align:center; margin-bottom:12px; font-weight:bold; }
        #display { font-size: clamp(36px,12vw,54px); text-align:center; font-weight:bold; margin:15px 0; font-family:monospace; }
        .time-input { display:flex; justify-content:center; gap:8px 12px; margin:15px 0; font-family:monospace; }
        .time-unit { width:70px; padding:10px; font-size:18px; text-align:center; border:1px solid #a2a9b1; border-radius:6px; background:white; }
        .time-label { align-self:center; min-width:60px; text-align:center; color:#54595d; font-size:13px; }
        #controls { display:flex; justify-content:center; gap:10px; margin:15px 0; flex-wrap:wrap; }
        button { padding:12px 16px; min-height:48px; border-radius:6px; cursor:pointer; border:1px solid #a2a9b1; background:#f8f9fa; }
        /* Progress bar area */
        .progress-wrap { width:100%; max-width:760px; margin:12px auto 0; padding:0 15px; }
        .progress-bar { position:relative; height:14px; background:#eee; border-radius:8px; overflow:hidden; cursor:pointer; border:1px solid #c84b4b; }
        .progress-fill { position:absolute; left:0; top:0; height:100%; width:0%; background:linear-gradient(90deg,#ff4b4b,#ff1a1a); transition:width 0.2s linear; }
        .tri {
            position:absolute; width:0; height:0; border-left:10px solid transparent; border-right:10px solid transparent;
            border-bottom:14px solid #ff1a1a; top:-12px; transform-origin:50% 50%;
            transition: left 0.04s linear;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { from { transform: rotate(0deg);} to { transform: rotate(360deg);} }
        .hidden { display:none; }
        /* small responsive */
        @media (max-width:480px){ .time-unit{width:58px; font-size:16px;} button{padding:10px 12px;} }
    </style>
</head>
<body>
    <div class="container">
        <h1>PLHKS Timer</h1>
        <div id="display">00:00:00</div>

        <div class="time-input" id="timeInputContainer">
            <input type="number" class="time-unit" id="hours" min="0" max="99" value="0">
            <span class="time-label">hours</span>
            <input type="number" class="time-unit" id="minutes" min="0" max="99" value="0">
            <span class="time-label">minutes</span>
            <input type="number" class="time-unit" id="seconds" min="0" max="99" value="0">
            <span class="time-label">seconds</span>
        </div>

        <div id="controls">
            <button id="startPause">Start</button>
            <button id="reset">Reset</button>
            <button id="modeSwitch">Switch to Stopwatch</button>
            <button id="themeBtn">Dark Mode</button>
            <button id="fullscreenBtn">Full Screen</button>
        </div>

        <div class="progress-wrap hidden" id="progressWrap">
            <div class="progress-bar" id="progressBar" aria-hidden="true">
                <div class="progress-fill" id="progressFill"></div>
                <div class="tri" id="tri" style="left:0;"></div>
            </div>
        </div>
    </div>

    <audio id="alarmSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmFgU7k9n1unEiBC13yO/eizEIHWq+8+OWT" type="audio/wav">
    </audio>

    <script>
        // Elements
        const display = document.getElementById('display');
        const startBtn = document.getElementById('startPause');
        const resetBtn = document.getElementById('reset');
        const modeBtn = document.getElementById('modeSwitch');
        const themeBtn = document.getElementById('themeBtn');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const hoursInput = document.getElementById('hours');
        const minutesInput = document.getElementById('minutes');
        const secondsInput = document.getElementById('seconds');
        const timeInputContainer = document.getElementById('timeInputContainer');
        const alarm = document.getElementById('alarmSound');

        const progressWrap = document.getElementById('progressWrap');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');
        const tri = document.getElementById('tri');

        // State
        let isTimerMode = true, isRunning = false, time = 0, interval = null;
        let startPressCount = 0, startPressTimer = null;
        let progressActive = false; // progress bar shown
        let totalDuration = 0; // total seconds for progress mapping

        // Helpers
        function pad(n){ return String(n).padStart(2,'0'); }
        function secsToHMS(s){ const h = Math.floor(s/3600); const m = Math.floor((s%3600)/60); const sec = s%60; return `${pad(h)}:${pad(m)}:${pad(sec)}`; }
        function updateDisplay(){ display.textContent = secsToHMS(time); updateProgressVisual(); }

        // Input enforcement: disallow minutes/seconds >59 except the special triple-67 case
        function enforceInputs() {
            // convert to numbers
            const h = Number(hoursInput.value || 0);
            const m = Number(minutesInput.value || 0);
            const s = Number(secondsInput.value || 0);
            const isSpecial67 = (h===67 && m===67 && s===67);

            // hours allowed up to 99 (no clamp here)
            if (hoursInput.value === '') hoursInput.value = 0;

            if (!isSpecial67) {
                // clamp minutes and seconds to 59
                if (m > 59) minutesInput.value = 59;
                if (s > 59) secondsInput.value = 59;
                if (minutesInput.value === '') minutesInput.value = 0;
                if (secondsInput.value === '') secondsInput.value = 0;
            } else {
                // special case: keep 67 as input (do nothing)
            }
        }

        hoursInput.addEventListener('input', enforceInputs);
        minutesInput.addEventListener('input', enforceInputs);
        secondsInput.addEventListener('input', enforceInputs);

        // Progress bar functions
        function showProgressBar() {
            if (progressActive) return;
            progressActive = true;
            progressWrap.classList.remove('hidden');
            // establish totalDuration and time mapping
            totalDuration = getInputSeconds(); // initial total
            if (!totalDuration) totalDuration = 1;
            // ensure time has been set
            time = Math.min(time, totalDuration);
            updateProgressVisual();
            // pointer events handled below
        }
        function hideProgressBar() {
            progressActive = false;
            progressWrap.classList.add('hidden');
        }
        function updateProgressVisual() {
            if (!progressActive) return;
            const percent = ((totalDuration - time) / totalDuration) * 100;
            // percent progress of elapsed (0% at start, 100% when finished)
            const clamped = Math.max(0, Math.min(100, percent));
            progressFill.style.width = clamped + '%';
            // move triangle to fill end (cap inside bar)
            const barWidth = progressBar.clientWidth;
            const px = (clamped / 100) * barWidth;
            const triLeft = Math.max(0, Math.min(barWidth - 1, px - 10)); // offset so arrow sits on edge
            tri.style.left = triLeft + 'px';
        }

        // Map click/drag on progress bar to remaining time
        function posToTime(clientX) {
            const rect = progressBar.getBoundingClientRect();
            const x = clientX - rect.left;
            const pct = Math.max(0, Math.min(1, x / rect.width));
            // pct = elapsed fraction; convert to remaining time
            const elapsed = pct * totalDuration;
            const newRemaining = Math.max(0, Math.round(totalDuration - elapsed));
            return newRemaining;
        }
        let dragging = false;
        progressBar.addEventListener('pointerdown', e => {
            dragging = true;
            progressBar.setPointerCapture(e.pointerId);
            time = posToTime(e.clientX);
            updateDisplay();
        });
        progressBar.addEventListener('pointermove', e => {
            if (!dragging) return;
            time = posToTime(e.clientX);
            updateDisplay();
        });
        progressBar.addEventListener('pointerup', e => {
            dragging = false;
            try { progressBar.releasePointerCapture(e.pointerId); } catch {}
        });

        // Timer logic
        function getInputSeconds() {
            const h = Number(hoursInput.value || 0);
            const m = Number(minutesInput.value || 0);
            const s = Number(secondsInput.value || 0);
            // for special triple 67, interpret as special total: 67h 67m 67s => convert normally
            return h*3600 + m*60 + s;
        }

        function startPause() {
            // special start-press double detection: count presses when timer is NOT running
            if (!isRunning) {
                startPressCount++;
                if (startPressTimer) clearTimeout(startPressTimer);
                startPressTimer = setTimeout(()=>{ startPressCount = 0; }, 1200); // reset after 1.2s
            }

            // If in timer mode and inputs are the special triple 67 and user pressed Start twice quickly,
            // show progress bar. We'll use startPressCount === 2 and not yet running.
            const h = Number(hoursInput.value || 0), m = Number(minutesInput.value || 0), s = Number(secondsInput.value || 0);
            const isSpecialTriple67 = (h === 67 && m === 67 && s === 67);

            // If not running: set time from inputs first
            if (!isRunning) {
                if (isTimerMode) {
                    time = getInputSeconds();
                    if (!time && !isSpecialTriple67) return; // nothing to start
                } else {
                    // stopwatch: start from 0
                    time = 0;
                }
            }

            // If special triple and double-press, toggle / show progress bar
            if (!isRunning && isTimerMode && isSpecialTriple67 && startPressCount === 2) {
                // prepare progress bar where totalDuration is the time set
                totalDuration = time || 1;
                showProgressBar();
            }

            if (isRunning) {
                stopTimer();
            } else {
                interval = setInterval(timerTick, 1000);
                startBtn.textContent = 'Pause';
            }
            isRunning = !isRunning;
        }

        function stopTimer() {
            clearInterval(interval);
            interval = null;
            isRunning = false;
            startBtn.textContent = 'Start';
        }

        function resetAll() {
            stopTimer();
            time = 0;
            totalDuration = 0;
            updateDisplay();
            hoursInput.value = minutesInput.value = secondsInput.value = 0;
            hideProgressBar();
        }

        function timerTick() {
            if (isTimerMode) {
                if (time > 0) {
                    time--;
                } else {
                    // reached zero
                    stopTimer();
                    alarm.currentTime = 0;
                    alarm.play().catch(()=>{});
                    // flash / keep progress full
                    time = 0;
                }
            } else {
                time++;
            }
            updateDisplay();
        }

        // Mode, theme, fullscreen basic hooks (kept minimal)
        function switchMode() {
            isTimerMode = !isTimerMode;
            modeBtn.textContent = isTimerMode ? 'Switch to Stopwatch' : 'Switch to Timer';
            timeInputContainer.style.display = isTimerMode ? 'flex' : 'none';
            resetAll();
        }
        function switchTheme() { document.body.classList.toggle('dark'); }
        function toggleFullScreen() {
            if (document.fullscreenElement) document.exitFullscreen();
            else document.documentElement.requestFullscreen();
        }

        // Initialize
        updateDisplay();
        // Hook events
        startBtn.onclick = startPause;
        resetBtn.onclick = resetAll;
        modeBtn.onclick = switchMode;
        themeBtn.onclick = switchTheme;
        fullscreenBtn.onclick = toggleFullScreen;

        // Keep progress synced if visible even when window resizes
        window.addEventListener('resize', ()=> requestAnimationFrame(updateProgressVisual));
    </script>
</body>
</html>
